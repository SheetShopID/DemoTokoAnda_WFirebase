<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Onlineshop (Mini)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f7f9fc; margin: 0; padding: 20px; }
  h1 { font-size: 1.5rem; margin-bottom: 1rem; }
  .cards { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .card { flex: 1; min-width: 150px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .card h2 { margin: 0 0 5px 0; font-size: 1rem; }
  .card p { margin: 0; font-size: 0.85rem; color: #555; }
  canvas { background: #fff; border-radius: 8px; padding: 10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  th, td { padding: 8px 12px; border: 1px solid #ddd; text-align: left; }
  th { background: #f0f0f0; }
  .refresh { float: right; margin-bottom: 1rem; padding: 5px 10px; border: none; background: #007bff; color: #fff; border-radius: 5px; cursor: pointer; }
</style>
</head>
<body>

<h1>Dashboard Onlineshop (Mini)
  <button class="refresh" onclick="loadDashboard()">Refresh</button>
</h1>

<div class="cards">
  <div class="card">
    <h2 id="totalRevenue">0</h2>
    <p>Total Revenue</p>
  </div>
  <div class="card">
    <h2 id="totalOrders">0</h2>
    <p>Total Orders</p>
  </div>
  <div class="card">
    <h2 id="unitsSold">0</h2>
    <p>Units Sold</p>
  </div>
</div>

<h3>Top Products</h3>
<canvas id="topProductsChart" height="150"></canvas>

<h3>Peringatan Ketersediaan Barang</h3>
<table>
  <thead>
    <tr>
      <th>Produk</th>
      <th>Stock</th>
    </tr>
  </thead>
  <tbody id="stockAlertsBody">
  </tbody>
</table>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzlk7s5K_PLw-LS7rjBr7UBBOTXLF7dpLbmIHO83D4EmBhpkQeyEzjXy9ufOGIyrpX1Ug/exec?dashboard=true";

let chart;

async function loadDashboard() {
  try {
    const res = await fetch(WEBAPP_URL);
    const json = await res.json();

    if (json.status !== "OK") {
      alert("Gagal ambil data dashboard: " + json.message);
      return;
    }

    const data = json.data;
    document.getElementById("totalRevenue").textContent = "Rp " + data.totalRevenue.toLocaleString();
    document.getElementById("totalOrders").textContent = data.totalOrders;
    document.getElementById("unitsSold").textContent = data.unitsSold;

    // Top Products Chart
    const ctx = document.getElementById("topProductsChart").getContext("2d");
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.topProducts.map(p => p.name),
        datasets: [{
          label: "Units Sold",
          data: data.topProducts.map(p => p.qty),
          backgroundColor: "rgba(54, 162, 235, 0.7)"
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: false }
        },
        scales: { y: { beginAtZero: true } }
      }
    });

    // Stock Alerts Table
    const tbody = document.getElementById("stockAlertsBody");
    tbody.innerHTML = "";
    data.stockAlerts.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${item.name}</td><td>${item.stock}</td>`;
      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error("‚ùå Load dashboard error:", err);
    alert("Gagal memuat dashboard.");
  }
}

// Load saat pertama buka
loadDashboard();
</script>

</body>
</html>
