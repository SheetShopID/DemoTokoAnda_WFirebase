<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Penjualan Jastip</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f7f9f8; margin:0; padding:20px; }
    h1 { color:#2f8f4a; }
    .dashboard-container { display:grid; grid-template-columns: repeat(auto-fit,minmax(350px,1fr)); gap:20px; }
    .card { background:white; border-radius:16px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
    .card h2 { font-size:18px; margin-bottom:10px; color:#333; }
    #totalSales { font-size:28px; font-weight:bold; color:#2f8f4a; }
    select { padding:8px 12px; border-radius:8px; border:1px solid #ccc; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Dashboard Penjualan Jastip</h1>
  <div style="margin-bottom:15px;">
    Filter Profil: <select id="profileFilter"></select>
  </div>
  <div class="dashboard-container">
    <div class="card">
      <h2>Total Penjualan</h2>
      <div id="totalSales">Rp0</div>
    </div>
    <div class="card">
      <h2>Top Produk Terlaris</h2>
      <canvas id="salesPerProductChart" height="200"></canvas>
    </div>
    <div class="card">
      <h2>Tren Penjualan Harian</h2>
      <canvas id="dailyTrendsChart" height="200"></canvas>
    </div>
    <div class="card">
      <h2>Top Profil Penjualan</h2>
      <canvas id="salesPerProfileChart" height="200"></canvas>
    </div>
  </div>

  <script> 
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBSJ-CWTC9TjSGL9b5hiSWRmttH-F-M2bM",
    authDomain: "ordersheetshopid.firebaseapp.com",
    databaseURL: "https://ordersheetshopid-default-rtdb.firebaseio.com",
    projectId: "ordersheetshopid",
    storageBucket: "ordersheetshopid.firebasestorage.app",
    messagingSenderId: "894838941192",
    appId: "1:894838941192:web:19008782f9bf5df25e13bd",
    measurementId: "G-5JT743CJ1V"
  };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ðŸ”¹ Dashboard Manager
    const OrderDashboardManager = (() => {
      const orders = [];

      const fetchOrders = async () => {
        const snapshot = await db.ref('orders').once('value');
        orders.length = 0;
        snapshot.forEach(snap => {
          const data = snap.val();
          data.id = snap.key;
          orders.push(data);
        });
        return orders;
      };

      const getTotalSales = filtered => filtered.reduce((sum, o) => sum + (o.total || 0), 0);

      const getOrdersPerProfile = filtered => {
        const map = {};
        filtered.forEach(o => { map[o.profileName] = (map[o.profileName] || 0) + o.total; });
        return map;
      };

      const getSalesPerProduct = filtered => {
        const map = {};
        filtered.forEach(o => o.items.forEach(i => {
          map[i.name] = (map[i.name] || 0) + i.qty;
        }));
        return map;
      };

      const getDailyTrends = filtered => {
        const map = {};
        filtered.forEach(o => {
          const day = new Date(o.timestamp).toISOString().slice(0, 10);
          map[day] = (map[day] || 0) + o.total;
        });
        return map;
      };

      return { fetchOrders, getTotalSales, getOrdersPerProfile, getSalesPerProduct, getDailyTrends, orders };
    })();

    // ðŸ”¹ Render Dashboard
    async function renderDashboard() {
      const allOrders = await OrderDashboardManager.fetchOrders();

      const profiles = [...new Set(allOrders.map(o => o.profileName))];
      const profileSelect = document.getElementById('profileFilter');
      profileSelect.innerHTML = `<option value="">Semua Profil</option>` +
        profiles.map(p => `<option value="${p}">${p}</option>`).join('');

      const applyFilter = () => {
        const filterVal = profileSelect.value;
        const filtered = filterVal ? allOrders.filter(o => o.profileName === filterVal) : allOrders;

        document.getElementById('totalSales').textContent =
          'Rp' + OrderDashboardManager.getTotalSales(filtered).toLocaleString();

        renderChart('salesPerProductChart', 'bar', 'Produk Terlaris', OrderDashboardManager.getSalesPerProduct(filtered));
        renderChart('dailyTrendsChart', 'line', 'Tren Harian', OrderDashboardManager.getDailyTrends(filtered));
        renderChart('salesPerProfileChart', 'bar', 'Penjualan per Profil', OrderDashboardManager.getOrdersPerProfile(filtered));
      };

      profileSelect.addEventListener('change', applyFilter);
      applyFilter();
    }
    const chartInstances = {};

    // ðŸ”¹ Helper: Render Chart
  function renderChart(canvasId, type, label, dataMap) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (chartInstances[canvasId]) chartInstances[canvasId].destroy(); // aman âœ…

  chartInstances[canvasId] = new Chart(ctx, {
    type,
    data: {
      labels: Object.keys(dataMap),
      datasets: [{
        label,
        data: Object.values(dataMap),
        backgroundColor: 'rgba(47, 143, 74, 0.5)',
        borderColor: 'rgba(47, 143, 74, 1)',
        borderWidth: 1,
        fill: type === 'line'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}


    window.addEventListener('load', renderDashboard);
  </script>
</body>
</html>
